<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥ - Lourdes v2</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        .drop-zone {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #4299e1;
            background-color: #ebf8ff;
        }
        .timer-display { font-family: 'Courier New', monospace; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const TaskManager = () => {
            const [tasks, setTasks] = useState([]);
            const [filter, setFilter] = useState('all');
            const [view, setView] = useState('tasks');
            const [showAddForm, setShowAddForm] = useState(false);
            const [showImportForm, setShowImportForm] = useState(false);
            const [importStatus, setImportStatus] = useState('');
            const [newTask, setNewTask] = useState({
                description: '',
                taskType: '',
                client: '',
                department: '',
                entryDate: '',
                deliveryDate: '',
                completionDate: '',
                timeMinutes: 0,
                status: 'Pendent',
                budget: '',
                clientResponsible: '',
                project: '',
                notes: ''
            });

            // Departamentos seg√∫n tu Excel original
            const departments = [
                'CONSULTORIA', 'ARPO', 'EDITORIAL', 'JUNY', 'FORNTERAH', 'DIRECCIO'
            ];

            const statusOptions = [
                'Pendent', 'In progress', 'Completat', 'Espero resposta client', 'Espero resposta 3ers'
            ];

            const taskTypes = [
                'PRESUPUESTO', 'REUNI√ìN', 'CONTRATO', 'REVISAR', 'FACTURAR', 'NEGOCIACI√ìN', 'OTRO'
            ];

            useEffect(() => {
                const savedTasks = localStorage.getItem('lourdes-tasks-v3');
                if (savedTasks) {
                    setTasks(JSON.parse(savedTasks));
                } else {
                    // Migrar datos de versi√≥n anterior si existen
                    const oldTasks = localStorage.getItem('lourdes-tasks-v2');
                    if (oldTasks) {
                        const parsedOldTasks = JSON.parse(oldTasks);
                        const migratedTasks = parsedOldTasks.map(task => ({
                            ...task,
                            taskType: task.taskType || '',
                            entryDate: task.createdAt ? task.createdAt.split('T')[0] : '',
                            completionDate: task.status === 'Completat' ? new Date().toISOString().split('T')[0] : '',
                            timeMinutes: Math.round((task.timeTracked || 0)),
                            client: task.clientName || '',
                            department: mapDepartment(task.department)
                        }));
                        setTasks(migratedTasks);
                        setImportStatus('‚úÖ Tareas migradas de la versi√≥n anterior');
                        setTimeout(() => setImportStatus(''), 3000);
                    }
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('lourdes-tasks-v3', JSON.stringify(tasks));
            }, [tasks]);

            const mapDepartment = (dept) => {
                const mapping = {
                    'Consultoria': 'CONSULTORIA',
                    'Editorial': 'EDITORIAL',
                    'Juny': 'JUNY',
                    'Fronterah': 'FORNTERAH',
                    'Publicitat': 'ARPO',
                    'Direcci√≥': 'DIRECCIO',
                    'Supervisi√≥ Cine': 'ARPO'
                };
                return mapping[dept] || dept;
            };

            const formatTime = (minutes) => {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            };

            const addTime = (taskId, minutes) => {
                setTasks(tasks.map(task => 
                    task.id === taskId 
                        ? { ...task, timeMinutes: (task.timeMinutes || 0) + minutes }
                        : task
                ));
            };

            const handleFileImport = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        let importedTasks = [];
                        let totalImported = 0;

                        // Procesar cada hoja (excepto DATOS)
                        workbook.SheetNames.forEach(sheetName => {
                            if (sheetName === 'DATOS') return;
                            
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            // Saltar la primera fila (headers) y procesar datos
                            jsonData.slice(1).forEach((row, index) => {
                                if (row[0] && row[0].trim()) { // Solo si hay descripci√≥n
                                    const task = {
                                        id: Date.now() + totalImported + index,
                                        description: row[0] || '',
                                        taskType: row[1] || '',
                                        client: row[2] || '',
                                        department: row[3] || sheetName,
                                        entryDate: excelDateToJSDate(row[4]),
                                        deliveryDate: formatDeliveryDate(row[5]),
                                        completionDate: excelDateToJSDate(row[6]),
                                        timeMinutes: parseInt(row[7]) || 0,
                                        status: row[6] ? 'Completat' : 'Pendent',
                                        budget: '',
                                        clientResponsible: '',
                                        project: '',
                                        notes: '',
                                        createdAt: new Date().toISOString(),
                                        source: 'excel-import'
                                    };
                                    importedTasks.push(task);
                                    totalImported++;
                                }
                            });
                        });

                        // A√±adir las tareas importadas a las existentes
                        setTasks(prevTasks => [...prevTasks, ...importedTasks]);
                        setImportStatus(`‚úÖ ${totalImported} tareas importadas correctamente desde ${workbook.SheetNames.filter(n => n !== 'DATOS').length} hojas`);
                        setShowImportForm(false);
                        
                        setTimeout(() => setImportStatus(''), 5000);
                        
                    } catch (error) {
                        console.error('Error importing:', error);
                        setImportStatus('‚ùå Error al leer el archivo. Aseg√∫rate de que es tu Excel original.');
                        setTimeout(() => setImportStatus(''), 5000);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            const excelDateToJSDate = (serial) => {
                if (!serial || typeof serial !== 'number') return '';
                try {
                    const utc_days = Math.floor(serial - 25569);
                    const utc_value = utc_days * 86400;
                    const date_info = new Date(utc_value * 1000);
                    return date_info.toISOString().split('T')[0];
                } catch {
                    return '';
                }
            };

            const formatDeliveryDate = (value) => {
                if (!value) return '';
                if (typeof value === 'string' && value.includes('SEMANA')) {
                    return value; // Mantener formato "SEMANA XX"
                }
                if (typeof value === 'number') {
                    return excelDateToJSDate(value);
                }
                return value.toString();
            };

            const exportToOriginalFormat = () => {
                // Agrupar tareas por departamento
                const tasksByDepartment = {
                    'CONSULTORIA': [],
                    'PUBLI': [],
                    'PELIS': [],
                    'JUNY': [],
                    'FRONTERAH': [],
                    'OTROS': []
                };

                tasks.forEach(task => {
                    const dept = task.department || 'OTROS';
                    const targetDept = dept === 'ARPO' ? 'PUBLI' : 
                                     dept === 'FORNTERAH' ? 'FRONTERAH' :
                                     dept === 'DIRECCIO' ? 'OTROS' : dept;
                    
                    if (!tasksByDepartment[targetDept]) {
                        tasksByDepartment[targetDept] = [];
                    }

                    const row = [
                        task.description || '',
                        task.taskType || '',
                        task.client || '',
                        task.department || '',
                        task.entryDate || '',
                        task.deliveryDate || '',
                        task.completionDate || '',
                        task.timeMinutes || 0
                    ];
                    
                    tasksByDepartment[targetDept].push(row);
                });

                // Crear workbook
                const wb = XLSX.utils.book_new();
                
                // Headers para todas las hojas
                const headers = [
                    'Descripci√≥n de la Tarea', '', 'CLIENTE', 'INTERN', 
                    'Fecha de Entrada', 'Entrega prevista', 'Fecha de Finalizaci√≥n', 
                    'Tiempo Empleado MINUTOS'
                ];

                // Crear hojas para cada departamento
                Object.entries(tasksByDepartment).forEach(([dept, deptTasks]) => {
                    if (deptTasks.length > 0) {
                        const wsData = [headers, ...deptTasks];
                        const ws = XLSX.utils.aoa_to_sheet(wsData);
                        XLSX.utils.book_append_sheet(wb, ws, dept);
                    }
                });

                // Hoja de datos (departamentos)
                const datosWs = XLSX.utils.aoa_to_sheet([
                    ['ARPO'],
                    ['CONSULTORIA'],
                    ['EDITORIAL'],
                    ['JUNY'],
                    ['FORNTERAH'],
                    ['DIRECCIO']
                ]);
                XLSX.utils.book_append_sheet(wb, datosWs, 'DATOS');

                // Generar nombre de archivo
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const filename = `Control_Tareas_Lou_${today}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                
                setImportStatus(`üìä Excel exportado: ${filename}`);
                setTimeout(() => setImportStatus(''), 3000);
            };

            const exportToAppFormat = () => {
                // Formato de la app (para backup)
                const tasksData = tasks.map(task => ({
                    'Descripci√≥': task.description,
                    'Tipus': task.taskType,
                    'Departament': task.department,
                    'Status': task.status,
                    'Temps (minuts)': task.timeMinutes,
                    'Pressupost (‚Ç¨)': task.budget || '0.00',
                    'Client': task.client,
                    'Responsable Client': task.clientResponsible,
                    'Projecte': task.project,
                    'Data Entrada': task.entryDate,
                    'Data Entrega': task.deliveryDate,
                    'Data Finalitzaci√≥': task.completionDate,
                    'Notes': task.notes,
                    'Data Creaci√≥': new Date(task.createdAt).toLocaleDateString('ca-ES')
                }));

                const analytics = calculateAnalytics();
                const analyticsData = [
                    ['M√®trica', 'Valor'],
                    ['Total Tasques', analytics.totalTasks],
                    ['Tasques Completades', analytics.completedTasks],
                    ['Tasques Pendents', analytics.pendingTasks],
                    ['Total Minuts', analytics.totalMinutes],
                    ['Total Hores', (analytics.totalMinutes / 60).toFixed(1)],
                    [''],
                    ['Tasques per Departament', ''],
                    ...Object.entries(analytics.byDepartment),
                    [''],
                    ['Tasques per Client', ''],
                    ...Object.entries(analytics.byClient).filter(([client]) => client.trim() !== '')
                ];

                const wb = XLSX.utils.book_new();
                const wsTaskes = XLSX.utils.json_to_sheet(tasksData);
                XLSX.utils.book_append_sheet(wb, wsTaskes, "Tasques");
                const wsAnalytics = XLSX.utils.aoa_to_sheet(analyticsData);
                XLSX.utils.book_append_sheet(wb, wsAnalytics, "Analytics");

                const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const filename = `backup-app-${today}.xlsx`;
                XLSX.writeFile(wb, filename);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        handleFileImport(file);
                    } else {
                        setImportStatus('‚ùå Por favor, selecciona un archivo Excel (.xlsx o .xls)');
                        setTimeout(() => setImportStatus(''), 3000);
                    }
                }
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.add('dragover');
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.remove('dragover');
            };

            const addTask = () => {
                if (!newTask.description.trim()) return;
                
                const task = {
                    ...newTask,
                    id: Date.now(),
                    createdAt: new Date().toISOString(),
                    timeMinutes: parseInt(newTask.timeMinutes) || 0,
                    budget: parseFloat(newTask.budget) || 0
                };
                
                setTasks([...tasks, task]);
                setNewTask({
                    description: '',
                    taskType: '',
                    client: '',
                    department: '',
                    entryDate: '',
                    deliveryDate: '',
                    completionDate: '',
                    timeMinutes: 0,
                    status: 'Pendent',
                    budget: '',
                    clientResponsible: '',
                    project: '',
                    notes: ''
                });
                setShowAddForm(false);
            };

            const updateTask = (id, updates) => {
                setTasks(tasks.map(task => 
                    task.id === id ? { ...task, ...updates } : task
                ));
            };

            const deleteTask = (id) => {
                setTasks(tasks.filter(task => task.id !== id));
            };

            const filteredTasks = tasks.filter(task => {
                if (filter === 'all') return true;
                if (filter === 'pending') return task.status === 'Pendent';
                if (filter === 'in-progress') return task.status === 'In progress';
                if (filter === 'completed') return task.status === 'Completat';
                if (filter === 'waiting-client') return task.status === 'Espero resposta client';
                if (filter === 'waiting-third') return task.status === 'Espero resposta 3ers';
                return true;
            });

            const getStatusColor = (status) => {
                switch (status) {
                    case 'Completat': return 'bg-green-100 text-green-800 border-green-300';
                    case 'In progress': return 'bg-blue-100 text-blue-800 border-blue-300';
                    case 'Pendent': return 'bg-red-100 text-red-800 border-red-300';
                    case 'Espero resposta client': return 'bg-yellow-100 text-yellow-800 border-yellow-300';
                    case 'Espero resposta 3ers': return 'bg-purple-100 text-purple-800 border-purple-300';
                    default: return 'bg-gray-100 text-gray-800 border-gray-300';
                }
            };

            const calculateAnalytics = () => {
                const analytics = {
                    totalTasks: tasks.length,
                    completedTasks: tasks.filter(t => t.status === 'Completat').length,
                    pendingTasks: tasks.filter(t => t.status === 'Pendent').length,
                    inProgressTasks: tasks.filter(t => t.status === 'In progress').length,
                    waitingClientTasks: tasks.filter(t => t.status === 'Espero resposta client').length,
                    waitingThirdTasks: tasks.filter(t => t.status === 'Espero resposta 3ers').length,
                    totalBudget: tasks.reduce((sum, t) => sum + (parseFloat(t.budget) || 0), 0),
                    totalMinutes: tasks.reduce((sum, t) => sum + (t.timeMinutes || 0), 0),
                    byDepartment: {},
                    byClient: {}
                };

                tasks.forEach(task => {
                    if (task.department) {
                        analytics.byDepartment[task.department] = (analytics.byDepartment[task.department] || 0) + 1;
                    }
                    if (task.client) {
                        analytics.byClient[task.client] = (analytics.byClient[task.client] || 0) + 1;
                    }
                });

                return analytics;
            };

            const analytics = calculateAnalytics();

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <h1 className="text-2xl font-bold text-gray-900">Sistema de Gesti√≥ - Lourdes v2</h1>
                                <div className="flex items-center space-x-3">
                                    <button
                                        onClick={() => setShowImportForm(true)}
                                        className="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700"
                                    >
                                        üìÅ Importar Excel
                                    </button>
                                    <button
                                        onClick={exportToOriginalFormat}
                                        className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700"
                                    >
                                        üìä Exportar Original
                                    </button>
                                    <button
                                        onClick={exportToAppFormat}
                                        className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
                                    >
                                        üíæ Backup App
                                    </button>
                                </div>
                            </div>
                            
                            {importStatus && (
                                <div className="bg-blue-50 border border-blue-200 rounded-md p-3 mb-4">
                                    <p className="text-blue-800">{importStatus}</p>
                                </div>
                            )}

                            <div className="flex space-x-2">
                                <button
                                    onClick={() => setView('tasks')}
                                    className={`px-4 py-2 rounded-md ${view === 'tasks' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}`}
                                >
                                    Tasques ({tasks.length})
                                </button>
                                <button
                                    onClick={() => setView('analytics')}
                                    className={`px-4 py-2 rounded-md ${view === 'analytics' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}`}
                                >
                                    üìà Analytics
                                </button>
                            </div>
                        </div>

                        {/* Import Form */}
                        {showImportForm && (
                            <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-lg font-semibold">Importar Excel Original</h2>
                                    <button
                                        onClick={() => setShowImportForm(false)}
                                        className="text-gray-500 hover:text-gray-700"
                                    >
                                        ‚úï
                                    </button>
                                </div>
                                
                                <div 
                                    className="drop-zone"
                                    onDrop={handleDrop}
                                    onDragOver={handleDragOver}
                                    onDragLeave={handleDragLeave}
                                    onClick={() => document.getElementById('fileInput').click()}
                                >
                                    <div className="text-center">
                                        <div className="text-4xl mb-4">üìÅ</div>
                                        <p className="text-lg font-medium mb-2">Arrastra tu Excel aqu√≠</p>
                                        <p className="text-gray-600 mb-4">o haz clic para seleccionar</p>
                                        <p className="text-sm text-gray-500">
                                            Sube tu archivo "Control_Tareas_Lou_Revisado.xlsx"<br/>
                                            Se importar√°n autom√°ticamente todas las hojas (CONSULTORIA, PUBLI, PELIS, etc.)
                                        </p>
                                    </div>
                                </div>
                                
                                <input
                                    id="fileInput"
                                    type="file"
                                    accept=".xlsx,.xls"
                                    onChange={(e) => {
                                        if (e.target.files[0]) {
                                            handleFileImport(e.target.files[0]);
                                        }
                                    }}
                                    className="hidden"
                                />
                            </div>
                        )}

                        {view === 'tasks' && (
                            <div>
                                {/* Filters */}
                                <div className="bg-white rounded-lg shadow-sm p-4 mb-6">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center space-x-4">
                                            <span>üîç</span>
                                            <select 
                                                value={filter} 
                                                onChange={(e) => setFilter(e.target.value)}
                                                className="border border-gray-300 rounded-md px-3 py-1"
                                            >
                                                <option value="all">Totes les tasques</option>
                                                <option value="pending">Pendents</option>
                                                <option value="in-progress">En progres</option>
                                                <option value="completed">Completades</option>
                                                <option value="waiting-client">Espero client</option>
                                                <option value="waiting-third">Espero 3ers</option>
                                            </select>
                                        </div>
                                        <button
                                            onClick={() => setShowAddForm(!showAddForm)}
                                            className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
                                        >
                                            ‚ûï Nova Tasca
                                        </button>
                                    </div>
                                </div>

                                {/* Add Form */}
                                {showAddForm && (
                                    <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                                        <h2 className="text-lg font-semibold mb-4">Nova Tasca</h2>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            <div className="md:col-span-2 lg:col-span-3">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Descripci√≥ de la Tasca</label>
                                                <textarea
                                                    value={newTask.description}
                                                    onChange={(e) => setNewTask({...newTask, description: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                                    placeholder="Descripci√≥ de la tasca"
                                                    rows="2"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Tipus de Tasca</label>
                                                <select
                                                    value={newTask.taskType}
                                                    onChange={(e) => setNewTask({...newTask, taskType: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                                >
                                                    <option value="">Seleccionar tipus</option>
                                                    {taskTypes.map(type => (
                                                        <option key={type} value={type}>{type}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Client</label>
                                                <input
                                                    type="text"
                                                    value={newTask.client}
                                                    onChange={(e) => setNewTask({...newTask, client: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                                    placeholder="Nom del client"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Departament</label>
                                                <select
                                                    value={newTask.department}
                                                    onChange={(e) => setNewTask({...newTask, department: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                                >
                                                    <option value="">Seleccionar departament</option>
                                                    {departments.map(dept => (
                                                        <option key={dept} value={dept}>{dept}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                                <select
                                                    value={newTask.status}
                                                    onChange={(e) => setNewTask({...newTask, status: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                                >
                                                    {statusOptions.map(status => (
                                                        <option key={status} value={status}>{status}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Data Entrada</label>
                                                <input
                                                    type="date"
                                                    value={newTask.entryDate}
                                                    onChange={(e) => setNewTask({...newTask, entryDate: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Data Entrega</label>
                                                <input
                                                    type="date"
                                                    value={newTask.deliveryDate}
                                                    onChange={(e) => setNewTask({...newTask, deliveryDate: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Pressupost (‚Ç¨)</label>
                                                <input
                                                    type="number"
                                                    value={newTask.budget}
                                                    onChange={(e) => setNewTask({...newTask, budget: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                                    placeholder="0,00"
                                                    step="0.01"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Responsable Client</label>
                                                <input
                                                    type="text"
                                                    value={newTask.clientResponsible}
                                                    onChange={(e) => setNewTask({...newTask, clientResponsible: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                                    placeholder="Persona responsable"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Projecte</label>
                                                <input
                                                    type="text"
                                                    value={newTask.project}
                                                    onChange={(e) => setNewTask({...newTask, project: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                                    placeholder="Nom del projecte"
                                                />
                                            </div>
                                            <div className="md:col-span-2 lg:col-span-3">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                                <textarea
                                                    value={newTask.notes}
                                                    onChange={(e) => setNewTask({...newTask, notes: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-md px-3 py-2"
                                                    placeholder="Notes addicionals"
                                                    rows="2"
                                                />
                                            </div>
                                        </div>
                                        <div className="flex space-x-3 mt-6">
                                            <button
                                                onClick={addTask}
                                                className="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700"
                                            >
                                                Crear Tasca
                                            </button>
                                            <button
                                                onClick={() => setShowAddForm(false)}
                                                className="bg-gray-300 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-400"
                                            >
                                                Cancel¬∑lar
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {/* Tasks Grid */}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {filteredTasks.map(task => (
                                        <div key={task.id} className="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                                            <div className="flex items-start justify-between mb-3">
                                                <h3 className="font-medium text-gray-900 flex-1 pr-2">{task.description}</h3>
                                                <span className={`px-2 py-1 text-xs rounded-full border ${getStatusColor(task.status)}`}>
                                                    {task.status}
                                                </span>
                                            </div>
                                            
                                            <div className="grid grid-cols-1 gap-1 text-sm text-gray-600 mb-3">
                                                {task.taskType && <div><strong>Tipus:</strong> {task.taskType}</div>}
                                                {task.department && <div><strong>Departament:</strong> {task.department}</div>}
                                                {task.client && <div><strong>Client:</strong> {task.client}</div>}
                                                {task.project && <div><strong>Projecte:</strong> {task.project}</div>}
                                                {task.clientResponsible && <div><strong>Responsable:</strong> {task.clientResponsible}</div>}
                                                {task.deliveryDate && <div><strong>Entrega:</strong> {task.deliveryDate}</div>}
                                                {task.entryDate && <div><strong>Entrada:</strong> {task.entryDate}</div>}
                                                {task.completionDate && <div><strong>Finalitzaci√≥:</strong> {task.completionDate}</div>}
                                            </div>

                                            <div className="flex items-center justify-between mb-3">
                                                <div className="flex items-center space-x-2">
                                                    <span>‚è±Ô∏è</span>
                                                    <span className="timer-display font-mono text-sm">{formatTime(task.timeMinutes || 0)}</span>
                                                    <button
                                                        onClick={() => addTime(task.id, 15)}
                                                        className="bg-green-100 text-green-600 px-2 py-1 rounded text-xs"
                                                    >
                                                        +15min
                                                    </button>
                                                    <button
                                                        onClick={() => addTime(task.id, 30)}
                                                        className="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs"
                                                    >
                                                        +30min
                                                    </button>
                                                </div>
                                                {(task.budget > 0) && (
                                                    <div className="text-sm text-gray-600">
                                                        üí∞ {parseFloat(task.budget).toFixed(2)}‚Ç¨
                                                    </div>
                                                )}
                                            </div>

                                            {task.notes && (
                                                <p className="text-sm text-gray-600 mb-3 italic bg-gray-50 p-2 rounded">{task.notes}</p>
                                            )}

                                            <div className="flex items-center justify-between border-t pt-3">
                                                <select 
                                                    value={task.status} 
                                                    onChange={(e) => updateTask(task.id, { status: e.target.value, completionDate: e.target.value === 'Completat' ? new Date().toISOString().split('T')[0] : '' })}
                                                    className="text-xs border border-gray-300 rounded px-2 py-1 flex-1 mr-2"
                                                >
                                                    {statusOptions.map(status => (
                                                        <option key={status} value={status}>{status}</option>
                                                    ))}
                                                </select>
                                                <button 
                                                    onClick={() => deleteTask(task.id)}
                                                    className="text-red-500 hover:text-red-700 text-sm px-2"
                                                >
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                            
                                            {task.source === 'excel-import' && (
                                                <div className="mt-2 text-xs text-purple-600 bg-purple-50 px-2 py-1 rounded">
                                                    üìÅ Importada d'Excel
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>

                                {filteredTasks.length === 0 && (
                                    <div className="bg-white rounded-lg shadow-sm p-8 text-center">
                                        <div className="text-4xl mb-4">üìã</div>
                                        <p className="text-gray-500 mb-4">No hi ha tasques que coincideixin amb el filtre seleccionat.</p>
                                        <p className="text-sm text-gray-400">
                                            {tasks.length === 0 
                                                ? "Comen√ßa afegint una nova tasca o importa el teu Excel original." 
                                                : "Prova a canviar el filtre per veure m√©s tasques."
                                            }
                                        </p>
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'analytics' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                                    <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                        <h3 className="font-semibold text-blue-900 text-sm">Total Tasques</h3>
                                        <p className="text-2xl font-bold text-blue-600">{analytics.totalTasks}</p>
                                    </div>
                                    <div className="bg-red-50 p-4 rounded-lg border border-red-200">
                                        <h3 className="font-semibold text-red-900 text-sm">Pendents</h3>
                                        <p className="text-2xl font-bold text-red-600">{analytics.pendingTasks}</p>
                                    </div>
                                    <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                                        <h3 className="font-semibold text-green-900 text-sm">Completades</h3>
                                        <p className="text-2xl font-bold text-green-600">{analytics.completedTasks}</p>
                                    </div>
                                    <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                        <h3 className="font-semibold text-yellow-900 text-sm">En Progres</h3>
                                        <p className="text-2xl font-bold text-yellow-600">{analytics.inProgressTasks}</p>
                                    </div>
                                    <div className="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                        <h3 className="font-semibold text-purple-900 text-sm">Total Hores</h3>
                                        <p className="text-2xl font-bold text-purple-600">{(analytics.totalMinutes / 60).toFixed(1)}</p>
                                    </div>
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                        <h3 className="font-semibold text-gray-900 text-sm">Pressupost</h3>
                                        <p className="text-2xl font-bold text-gray-600">{analytics.totalBudget.toFixed(0)}‚Ç¨</p>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="bg-white p-6 rounded-lg border shadow-sm">
                                        <h3 className="font-semibold mb-4 text-lg">üìä Tasques per Departament</h3>
                                        {Object.entries(analytics.byDepartment).length > 0 ? (
                                            Object.entries(analytics.byDepartment)
                                                .sort(([,a], [,b]) => b - a)
                                                .map(([dept, count]) => (
                                                <div key={dept} className="flex justify-between items-center py-3 border-b border-gray-100 last:border-b-0">
                                                    <span className="font-medium">{dept}</span>
                                                    <div className="flex items-center space-x-3">
                                                        <div className="bg-blue-100 px-3 py-1 rounded-full">
                                                            <span className="text-blue-800 font-semibold">{count}</span>
                                                        </div>
                                                        <div className="w-20 bg-gray-200 rounded-full h-2">
                                                            <div 
                                                                className="bg-blue-500 h-2 rounded-full" 
                                                                style={{width: `${(count / analytics.totalTasks) * 100}%`}}
                                                            ></div>
                                                        </div>
                                                        <span className="text-sm text-gray-500">
                                                            {((count / analytics.totalTasks) * 100).toFixed(0)}%
                                                        </span>
                                                    </div>
                                                </div>
                                            ))
                                        ) : (
                                            <p className="text-gray-500 text-center py-8">No hi ha dades disponibles</p>
                                        )}
                                    </div>
                                    
                                    <div className="bg-white p-6 rounded-lg border shadow-sm">
                                        <h3 className="font-semibold mb-4 text-lg">üë• Tasques per Client</h3>
                                        {Object.entries(analytics.byClient).length > 0 ? (
                                            Object.entries(analytics.byClient)
                                                .filter(([client]) => client.trim() !== '')
                                                .sort(([,a], [,b]) => b - a)
                                                .slice(0, 10)
                                                .map(([client, count]) => (
                                                <div key={client} className="flex justify-between items-center py-3 border-b border-gray-100 last:border-b-0">
                                                    <span className="font-medium truncate flex-1 mr-3">{client}</span>
                                                    <div className="flex items-center space-x-3">
                                                        <div className="bg-green-100 px-3 py-1 rounded-full">
                                                            <span className="text-green-800 font-semibold">{count}</span>
                                                        </div>
                                                        <div className="w-16 bg-gray-200 rounded-full h-2">
                                                            <div 
                                                                className="bg-green-500 h-2 rounded-full" 
                                                                style={{width: `${(count / analytics.totalTasks) * 100}%`}}
                                                            ></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        ) : (
                                            <p className="text-gray-500 text-center py-8">No hi ha dades disponibles</p>
                                        )}
                                    </div>
                                </div>

                                <div className="bg-white p-6 rounded-lg border shadow-sm">
                                    <h3 className="font-semibold mb-4 text-lg">üéØ Resum Executiu</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                        <div className="text-center">
                                            <div className="text-3xl font-bold text-blue-600 mb-2">
                                                {analytics.totalTasks > 0 ? ((analytics.completedTasks / analytics.totalTasks) * 100).toFixed(0) : 0}%
                                            </div>
                                            <div className="text-sm text-gray-600">Taxa de Completat</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-3xl font-bold text-purple-600 mb-2">
                                                {analytics.totalMinutes > 0 ? (analytics.totalMinutes / 60).toFixed(1) : 0}h
                                            </div>
                                            <div className="text-sm text-gray-600">Temps Total Registrat</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-3xl font-bold text-green-600 mb-2">
                                                {analytics.completedTasks > 0 ? (analytics.totalMinutes / analytics.completedTasks / 60).toFixed(1) : 0}h
                                            </div>
                                            <div className="text-sm text-gray-600">Mitjana per Tasca</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-3xl font-bold text-yellow-600 mb-2">
                                                {Object.keys(analytics.byDepartment).length}
                                            </div>
                                            <div className="text-sm text-gray-600">Departaments Actius</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<TaskManager />, document.getElementById('root'));
    </script>
</body>
</html> 
